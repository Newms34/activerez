"use strict";var socket=io(),app=angular.module("ribbon-app",["ui.router","ngAnimate","ui.bootstrap","ngSanitize"]),resetApp=angular.module("reset-app",[]);Array.prototype.findUser=function(e){for(var t=0;t<this.length;t++)if(this[t].user==e)return t;return-1},app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,o){o.html5Mode(!0),t.otherwise("/404"),e.state("app",{"abstract":!0,templateUrl:"layouts/full.html"}).state("app.dash",{url:"/",templateUrl:"components/dash.html"}).state("app.inbox",{url:"/inbox",templateUrl:"components/inbox.html"}).state("app.group",{url:"/group","abstract":!0,template:"<ui-view></ui-view>"}).state("app.group.my",{url:"/my",templateUrl:"components/group/my.html"}).state("app.group.list",{url:"/list",templateUrl:"components/group/list.html"}).state("app.group.create",{url:"/create",templateUrl:"components/group/create.html"}).state("app.help",{url:"/help",templateUrl:"components/help/help.html"}).state("appSimp",{"abstract":!0,templateUrl:"components/layout/simp.html"}).state("appSimp.login",{url:"/login",templateUrl:"components/login.html"}).state("appSimp.register",{url:"/register",templateUrl:"components/register.html"}).state("appSimp.notfound",{url:"/404",templateUrl:"components/alt/404.html"}).state("appSimp.err",{url:"/500",templateUrl:"components/alt/500.html"})}]),app.controller("chat-cont",["$scope","userFact","$http","$state","$sce",function(e,t,o,r,n){e.user=null,t.getUser().then(function(t){e.user=t.user,e.getUsrGroups()}),e.hideMe=function(){angular.element("#full-win").scope().showChat=!1,e.$digest()},e.chatGrps=[{title:"Error",groupId:"abc123",description:"This group should not show up!"}],e.prevMsgs=[],e.messages={},e.getUsrGroups=function(){o.post("/group/allByUsr",{user:e.user.name}).then(function(t){e.chatGrps=[],e.messages={},console.log("GROUPS:",t);var o=[];t.data instanceof Array&&(t.data.forEach(function(t){console.log("reinserting messages for group",t),t.recentTime=0,e.messages[t.groupId]=[{name:"Server",msg:'<span class="text-muted"><b>Server:</b> Welcome to '+t.title+" chat! Type <i>/wiki &lt;term&gt;</i> to search Wikipedia or <i>/google &lt;term&gt;</i> to search Google. Your moderator is "+t.creator+"</span>",grp:t.groupId,read:!0}],t.messages.forEach(function(o){var r={msg:o.msg,name:o.user,id:t.groupId};e.parseMsg(r,!0)}),e.chatGrps.push(t),console.log("GROUPS NOW",e.chatGrps),o.push(t.groupId)}),e.switchChat(e.chatGrps[0].groupId),socket.emit("joinRooms",{rooms:o,user:e.user.name}),$("#msg-inp").focus())})},socket.on("refreshGrps",function(){e.getUsrGroups()}),e.send=function(){o.post("/group/msg",{id:e.currId,msg:e.msgTxt,user:e.user.name}).then(function(t){return"err"==t.data?void bootbox.alert("There's been some sort of error with the chat system! Sorry!"):(e.prevMsgs.push(e.msgTxt),e.prevMsgs.length>20&&e.prevMsgs.shift(),e.msgTxt="",e.currCycMsg=e.prevMsgs.length,$("#msg-inp").focus(),e.user.lastRead=(new Date).getTime(),void o.post("/group/setLastRead",{user:e.user.name,id:e.currId}))})},e.switchChat=function(t){$(".chat-main").fadeOut(200,function(){e.currId=t,e.messages[t].forEach(function(e){e.read=!0}),e.$digest(),$(".chat-main").fadeIn()})},e.getNumUnread=function(t){var o=0;return e.messages[t].forEach(function(e){o+=e.read?0:1}),"+"+o},e.parseMsg=function(t,o){return t.grp=t.grp||t.id,!!t.msg&&(console.log("attempting to parse message",t),0==t.msg.indexOf("/wiki ")?t.msg='<a target="_blank" href="https://en.wikipedia.org/wiki/'+t.msg.slice(6).replace(/\s/,"_")+'">'+t.msg.slice(6)+"</a>":0==t.msg.indexOf("/google ")&&(t.msg='<a target="_blank" href="https://www.google.com/search?q='+t.msg.slice(8).replace(/\s/,"+")+'">'+t.msg.slice(8)+"</a>"),t.msg="<b>"+t.name+"</b>:"+t.msg,e.currId==t.grp||o?t.read=!0:t.read=!1,void e.messages[t.grp].push(t))},socket.on("chatOut",function(t){e.parseMsg(t),e.$digest()}),document.querySelector("#msg-inp").addEventListener("keydown",function(t){38==t.which&&e.currCycMsg>0?(e.currCycMsg--,e.msgTxt=e.prevMsgs[e.currCycMsg]):40==t.which&&e.currCycMsg<e.prevMsgs.length?(e.currCycMsg++,e.currCycMsg<e.prevMsgs.length-1?e.msgTxt=e.prevMsgs[e.currCycMsg]:e.msgTxt=""):27==t.which&&(e.msgTxt=""),e.$digest()})}]),app.controller("log-cont",["$scope","$http","$state","$q","userFact",function(e,t,o,r,n){e.person={jobs:[],edu:[],oth:[],skills:[]},e.allSkills=[],e.tags=[],e.newSkill={name:"",tags:[]},e.pushNewItem=function(t){if("Work"==t)e.person.jobs.push(angular.copy(e.newWork)),e.newWork={};else{var o=t.toLowerCase();console.log("pushing into",e.person[o]),e.person[o].push(angular.copy(e["new"+t])),e["new"+t]={},console.log("result",e.person[o])}e["add"+t+"Viz"]=!1},e.pickTitle=function(){e.newJobNew?e.person.jobTitle=e.jobNew:e.person.jobTitle=e.jobOld,e.titlePicked=!0},t.get("/skills/all").then(function(t){e.allSkills=t.data}),t.get("/tags/all").then(function(t){e.tags=t.data}),e.goReg=function(){o.go("appSimp.register")},e.goLog=function(){o.go("appSimp.login")},e.forgot=function(){return e.user?void t.post("/user/forgot",{user:e.user}).then(function(e){console.log("forgot route response",e),bootbox.alert("Check your email! If your username is registered, you should recieve an email from us with a password reset link.")}):void bootbox.alert("To recieve a password reset email, please enter your username!")},e.signin=function(){return e.user&&e.pwd?void t.post("/user/login",{name:e.user,pass:e.pwd}).then(function(t){t.data&&"no"!=t.data?window.location.href="./":bootbox.alert("Invalid username or password!",function(){e.pwd="",e.user="",e.$digest()})}):(bootbox.alert("Please enter your username and password."),!1)},e.titlePicked=!1,e.nameDup=!1,e.nt=null,e.nameTimer=function(){e.nt&&clearTimeout(e.nt),e.nt=setTimeout(function(){e.checkName()},500)},e.checkName=function(){t.get("/user/nameOkay/"+e.user).then(function(t){console.log(t.data),e.nameDup="okay"!=t.data})},e.explTxts=["Basic information for your account. You know, the usual stuff, like login info.","General information. Who/where are you.","Give potential employers a summary of who you are. Write brief summary of yourself, and pick a job title.","What positions have you had in the past?","Where did you learn your stuff? Tell us here!","Not all great experience comes from a 9-to-5. Got some great extra-curricular experience? Let us know here!","The fun part! Tell us all the cool things you can do! Either pick a skill from the list, or add your own."],e.expl=function(t){bootbox.alert(e.explTxts[t])},n.getDefaultLoc().then(function(t){e.city=t.city,e.state=t.region_name}),e.reg=function(){return e.regForm.$valid?void(e.pwd!=e.pwdDup?bootbox.alert("Your passwords don&rsquo;t match!"):e.nameDup?bootbox.alert("Someone&rsquo;s already using this username. Please pick another one!"):e.doReg()):(bootbox.alert("One or more of your fields is missing. Please double-check your information!"),!1)},e.doReg=function(){return console.log("FULL PERSON OBJ:",e.person),!1},e.newWork={},e.newEdu={},e.addOthViz=!1,e.addWorkViz=!1,e.addEduViz=!1,e.addTag=function(){return!!e.newSkillTag&&void e.newSkill.tags.push({name:e.newSkillTag,rating:100})},e.newSkNew=!1,e.newJobNew=!1,e.skillsToRecord=[],e.removeTag=function(t){e.newSkill.slice(t,1)},e.addSkill=function(){var t=null;e.newSkNew?(t=angular.copy(e.newSkill),e.skillsToRecord.push(angular.copy(t))):t=angular.copy(e.pikSkill),e.pikSkill="",e.newSkill=={name:"",tags:[]},t.yrs=0,e.person.skills.push(t)},e.jobTitles=["Front-end developer","UI/UX Specialist","Tank","Healer","DPS","Back-end developer"]}]),String.prototype.capMe=function(){return this.slice(0,1).toUpperCase()+this.slice(1)},app.controller("main-cont",["$scope","$http","$state","userFact",function(e,t,o,r){e.logout=function(){bootbox.confirm("Are you sure you wish to logout?",function(e){return!e||null==e||void t.get("/user/logout").then(function(e){console.log(e),o.go("appSimp.login")})})},e.hidden={general:!1,personal:!1,account:!1},e.refUsr=function(){r.getUser().then(function(t){e.user=t.user,e.user.work=[{start:new Date("1/2/1934"),end:new Date("5/6/1978"),cName:"ABC Widgets",position:"Widget Midget",loc:"Citysville, Townland",other:"Made widgets with digits."}],e.user.edu=[{start:new Date("5/3/01"),end:new Date("5/6/03"),sName:"School of Funk",degree:"PhD in Awesomeness",other:"Learned how to be funky"}],e.skillList=[{name:"HTML",desc:"Hypertext Markup Language"},{name:"CSS",desc:"Cascading Style Sheets"},{name:"JS",desc:"JavaScript"},{name:"AngularJS",desc:"Front-end library"},{name:"NodeJS",desc:"Back-end JavaScript Runtime Environment"},{name:"Bootstrap",desc:"CSS Framework"},{name:"jQuery",desc:"Isn't actually that bad."}],e.user.skills=[{id:0,yrs:10},{id:2,yrs:6},{id:3,yrs:4}],e.$digest()})},e.refUsr(),e.user=null}]),app.controller("nav-cont",["$scope","$http",function(e,t){}]),resetApp.controller("reset-contr",["$scope","$http",function(e,t){e.key=window.location.href.slice(window.location.href.lastIndexOf("/")+1),t.get("/user/resetUsr/"+e.key).then(function(t){e.user=t.data}),e.doReset=function(){e.user&&e.pwd&&e.pwdDup&&e.pwdDup==e.pwd&&e.key?t.post("/user/resetPwd",{acct:e.user.name,pwd:e.pwd,key:e.key}).then(function(e){"err"==e.data?bootbox.alert("There was an error resetting your password."):window.location.href="../../login"}):bootbox.alert("Error: Missing data. Make sure you&rsquo;ve reached this page from a password reset link, and that you have entered the same password in both fields!")}}]),app.factory("socketFac",["$rootScope",function(e){var t=io.connect();return{on:function(o,r){t.on(o,function(){var o=arguments;e.$apply(function(){r.apply(t,o)})})},emit:function(o,r,n){t.emit(o,r,function(){var o=arguments;e.$apply(function(){n&&n.apply(t,o)})})}}}]),app.run(["$rootScope","$state","$stateParams","$transitions","$q","userFact",function(e,t,o,r,n,s){r.onBefore({to:"app.**"},function(e){var o=n.defer();console.log("TRANS",e);var r=e.injector().get("userFact");return r.getUser().then(function(e){console.log(e.result),e.result?o.resolve(!0):o.resolve(t.target("appSimp.login",void 0,{location:!0}))}),o.promise})}]),app.factory("userFact",["$http",function(e){return{makeGroup:function(){},getDefaultLoc:function(){return e.get("//freegeoip.net/json/").then(function(e){return e.data})},getUser:function(){return e.get("/user/chkLog").then(function(e){return console.log("getUser in fac says:",e),e.data})}}}]);