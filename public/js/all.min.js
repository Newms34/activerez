"use strict";var socket=io(),app=angular.module("ribbon-app",["ui.router","ngAnimate","ui.bootstrap","ngSanitize","chart.js"]),resetApp=angular.module("reset-app",[]);Array.prototype.findUser=function(e){for(var t=0;t<this.length;t++)if(this[t].user==e)return t;return-1},app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,o){o.html5Mode(!0),t.otherwise("/404"),e.state("app",{"abstract":!0,templateUrl:"layouts/full.html"}).state("app.dash",{url:"/",templateUrl:"components/dash.html"}).state("app.find",{url:"/find",templateUrl:"components/find.html"}).state("app.help",{url:"/help",templateUrl:"components/help/help.html"}).state("appSimp",{"abstract":!0,templateUrl:"components/layout/simp.html"}).state("appSimp.login",{url:"/login",templateUrl:"components/login.html"}).state("appSimp.register",{url:"/register",templateUrl:"components/register.html"}).state("appSimp.notfound",{url:"/404",templateUrl:"components/alt/404.html"}).state("appSimp.err",{url:"/500",templateUrl:"components/alt/500.html"})}]),app.controller("chat-cont",["$scope","userFact","$http","$state","$sce",function(e,t,o,s,r){e.user=null,t.getUser().then(function(t){e.user=t.user,e.getUsrGroups()}),e.hideMe=function(){angular.element("#full-win").scope().showChat=!1,e.$digest()},e.chatGrps=[{title:"Error",groupId:"abc123",description:"This group should not show up!"}],e.prevMsgs=[],e.messages={},e.getUsrGroups=function(){o.post("/group/allByUsr",{user:e.user.name}).then(function(t){e.chatGrps=[],e.messages={},console.log("GROUPS:",t);var o=[];t.data instanceof Array&&(t.data.forEach(function(t){console.log("reinserting messages for group",t),t.recentTime=0,e.messages[t.groupId]=[{name:"Server",msg:'<span class="text-muted"><b>Server:</b> Welcome to '+t.title+" chat! Type <i>/wiki &lt;term&gt;</i> to search Wikipedia or <i>/google &lt;term&gt;</i> to search Google. Your moderator is "+t.creator+"</span>",grp:t.groupId,read:!0}],t.messages.forEach(function(o){var s={msg:o.msg,name:o.user,id:t.groupId};e.parseMsg(s,!0)}),e.chatGrps.push(t),console.log("GROUPS NOW",e.chatGrps),o.push(t.groupId)}),e.switchChat(e.chatGrps[0].groupId),socket.emit("joinRooms",{rooms:o,user:e.user.name}),$("#msg-inp").focus())})},socket.on("refreshGrps",function(){e.getUsrGroups()}),e.send=function(){o.post("/group/msg",{id:e.currId,msg:e.msgTxt,user:e.user.name}).then(function(t){return"err"==t.data?void bootbox.alert("There's been some sort of error with the chat system! Sorry!"):(e.prevMsgs.push(e.msgTxt),e.prevMsgs.length>20&&e.prevMsgs.shift(),e.msgTxt="",e.currCycMsg=e.prevMsgs.length,$("#msg-inp").focus(),e.user.lastRead=(new Date).getTime(),void o.post("/group/setLastRead",{user:e.user.name,id:e.currId}))})},e.switchChat=function(t){$(".chat-main").fadeOut(200,function(){e.currId=t,e.messages[t].forEach(function(e){e.read=!0}),e.$digest(),$(".chat-main").fadeIn()})},e.getNumUnread=function(t){var o=0;return e.messages[t].forEach(function(e){o+=e.read?0:1}),"+"+o},e.parseMsg=function(t,o){return t.grp=t.grp||t.id,!!t.msg&&(console.log("attempting to parse message",t),0==t.msg.indexOf("/wiki ")?t.msg='<a target="_blank" href="https://en.wikipedia.org/wiki/'+t.msg.slice(6).replace(/\s/,"_")+'">'+t.msg.slice(6)+"</a>":0==t.msg.indexOf("/google ")&&(t.msg='<a target="_blank" href="https://www.google.com/search?q='+t.msg.slice(8).replace(/\s/,"+")+'">'+t.msg.slice(8)+"</a>"),t.msg="<b>"+t.name+"</b>:"+t.msg,e.currId==t.grp||o?t.read=!0:t.read=!1,void e.messages[t.grp].push(t))},socket.on("chatOut",function(t){e.parseMsg(t),e.$digest()}),document.querySelector("#msg-inp").addEventListener("keydown",function(t){38==t.which&&e.currCycMsg>0?(e.currCycMsg--,e.msgTxt=e.prevMsgs[e.currCycMsg]):40==t.which&&e.currCycMsg<e.prevMsgs.length?(e.currCycMsg++,e.currCycMsg<e.prevMsgs.length-1?e.msgTxt=e.prevMsgs[e.currCycMsg]:e.msgTxt=""):27==t.which&&(e.msgTxt=""),e.$digest()})}]),app.controller("find-ctrl",["$scope","userFact","$http","$q",function(e,t,o,s){function r(e,t,o){e/=360,t/=100,o/=100;var s=void 0,r=void 0,n=void 0;if(0===t)s=r=n=o;else{var a=function(e,t,o){return o<0&&(o+=1),o>1&&(o-=1),o<1/6?e+6*(t-e)*o:o<.5?t:o<2/3?e+(t-e)*(2/3-o)*6:e},i=o<.5?o*(1+t):o+t-o*t,l=2*o-i;s=a(l,i,e+1/3),r=a(l,i,e),n=a(l,i,e-1/3)}var c=function(e){var t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t};return"#"+c(s)+c(r)+c(n)}e.srchMode=0,e.topics=[{name:"Name",icon:"user",desc:"Find a user by name"},{name:"Skill",icon:"cogs",desc:"Find a user by one of their skills"},{name:"Tag",icon:"tag",desc:"Find a user by one of the tags on their skills"}],e.deetUser=-1,e.t=null,e.users=[],e.chartTypes=[{name:"Skills Per Tag",msg:"View how many skills this user has in each tag.",id:0},{name:"Max Years Per Tag",msg:"View how many years maximum this user has in each tag.",id:1},{name:"Custom Chart: Years per skill",msg:"Generate a custom chart by adding specific skills.",id:2},{name:"Repos by Language",msg:"Github Repositories, organized by language",id:3}],e.makeChtData=function(){e.cht.labels=[],e.cht.data=[[]];var t={};if(0==e.chartFmt.id){e.cht.title="Number of Skills Per Tag";var s=e.user.skills.map(function(t){for(var o=0;o<e.skills.length;o++)if(e.skills[o].name==t.name)return e.skills[o]});s.forEach(function(e){e.tags.forEach(function(e){t[e.name]?t[e.name]++:t[e.name]=1})})}else if(1==e.chartFmt.id){e.cht.title="Maximum Years per Tag";var s=e.user.skills.map(function(t){for(var o=0;o<e.skills.length;o++)if(e.skills[o].name==t.name){var s=angular.copy(e.skills[o]);return s.yrs=t.yrs,s}});s.forEach(function(e){e.tags.forEach(function(o){t[o.name]?t[o.name]<e.yrs&&(t[o.name]=e.yrs):t[o.name]=1})})}else 2==e.chartFmt.id?(e.cht.labels=["Add skills by selecting them to the left."],e.cht.data[0]=[1]):e.users[e.deetUser].github?o.post("/user/gitgud",{user:e.user.github}).then(function(t){console.log(t.data),e.cht.labels=t.data.lbls,e.cht.data[0]=t.data.data,console.log("CHART:",e.cht),e.doColors()}):bootbox.alert("This user has not entered a github username!",function(){e.chartFmt=e.chartTypes[0],e.makeChtData()});if(e.chartFmt.id<2){for(var r in t)e.cht.labels.push(r),e.cht.data[0].push(t[r]);e.doColors()}},e.doColors=function(){var t=0;e.cht.colors[0].backgroundColor=[];for(var o=0;o<e.cht.labels.length;o++){var s=r(t,60,50);e.cht.colors[0].backgroundColor.push(s),t=(t+67)%360}},e.customAddSkill=function(){return console.log("STUFF:",e.chartFmt,e.newChtSkill),2==e.chartFmt.id&&("Add skills by selecting them to the left."==e.cht.labels[0]&&(e.cht.labels=[],e.cht.data=[[]]),e.cht.data[0].push(e.newChtSkill.yrs),e.cht.labels.push(e.newChtSkill.name),void e.doColors())},e.cht={title:"",data:[new Array(3).fill(100,0).map(function(e){return 12*Math.random()})],options:{maintainAspectRatio:!1,responsive:!0,legend:{display:!0,position:"right"}},labels:["Front-End","Back-End","Framework"],colors:[{backgroundColor:["#090","#009","#900"]}]},o.get("/skills/all").then(function(t){e.skills=t.data}),e.searchTimer=function(){e.t&&clearTimeout(e.t),e.t=setTimeout(function(){0===e.srchMode?o.get("/user/allUsrs").then(function(t){e.users=t.data.filter(function(t){return t.first.toLowerCase().indexOf(e.searchParam.toLowerCase())>-1||t.last.toLowerCase().indexOf(e.searchParam.toLowerCase())>-1}),e.deetUser=-1}):1===e.srchMode?o.get("/user/bySkill/"+e.searchParam).then(function(t){e.users=t.data,e.deetUser=-1}):o.get("/user/byTag/"+e.searchParam).then(function(t){e.users=t.data,e.deetUser=-1})},500)}}]),app.controller("log-cont",["$scope","$http","$state","$q","userFact",function(e,t,o,s,r){e.person={jobs:[],edu:[],oth:[],skills:[]},e.allSkills=[],e.tags=[],e.newSkill={name:"",tags:[]},e.pushNewItem=function(t){if("Work"==t)e.person.jobs.push(angular.copy(e.newWork)),e.newWork={};else{var o=t.toLowerCase();console.log("pushing into",e.person[o]),e.person[o].push(angular.copy(e["new"+t])),e["new"+t]={},console.log("result",e.person[o])}e["add"+t+"Viz"]=!1},e.pickTitle=function(){e.newJobNew?e.person.jobTitle=e.jobNew:e.person.jobTitle=e.jobOld,e.titlePicked=!0},t.get("/skills/all").then(function(t){e.allSkills=t.data}),t.get("/tags/all").then(function(t){e.tags=t.data}),e.goReg=function(){o.go("appSimp.register")},e.goLog=function(){o.go("appSimp.login")},e.forgot=function(){return e.user?void t.post("/user/forgot",{user:e.user}).then(function(e){console.log("forgot route response",e),bootbox.alert("Check your email! If your username is registered, you should recieve an email from us with a password reset link.")}):void bootbox.alert("To recieve a password reset email, please enter your username!")},e.signin=function(){return e.user&&e.pwd?void t.post("/user/login",{user:e.user,pwd:e.pwd}).then(function(t){t.data&&"no"!=t.data?window.location.href="./":bootbox.alert("Invalid username or password!",function(){e.pwd="",e.user="",e.$digest()})}):(bootbox.alert("Please enter your username and password."),!1)},e.titlePicked=!1,e.nameDup=!1,e.nt=null,e.nameTimer=function(){e.nt&&clearTimeout(e.nt),e.nt=setTimeout(function(){e.checkName()},500)},e.checkName=function(){t.get("/user/nameOkay/"+e.user).then(function(t){console.log(t.data),e.nameDup="okay"!=t.data})},e.explTxts=["Basic information for your account. You know, the usual stuff, like login info.","General information. Who/where are you.","Give potential employers a summary of who you are. Write brief summary of yourself, and pick a job title.","What positions have you had in the past?","Where did you learn your stuff? Tell us here!","Not all great experience comes from a 9-to-5. Got some great extra-curricular experience? Let us know here!","The fun part! Tell us all the cool things you can do! Either pick a skill from the list, or add your own."],e.expl=function(t){bootbox.alert(e.explTxts[t])},r.getDefaultLoc().then(function(t){e.city=t.city,e.state=t.region_name}),e.reg=function(){for(var t=[],o=0;o<e.person.skills.length;o++)e.person.skills[o].yrs||t.push(e.person.skills[o].name);return e.regForm.$valid?void(e.person.pwd!=e.pwdDup?bootbox.alert("Your passwords don&rsquo;t match!"):e.nameDup?bootbox.alert("Someone&rsquo;s already using this username. Please pick another one!"):t.length?bootbox.confirm({message:"The following skills have their Years of Experience set to zero!<br/><ul><li>"+t.join("</li><li>")+"</li></ul><br/>We'd recommend either increasing the years of experience to at least 0.5 (half a year), or removing the skill. Are you sure you want to continue?",callback:function(t){t&&e.doReg()}}):e.doReg()):(bootbox.alert("One or more of your fields is missing. Please double-check your information!"),!1)},e.doReg=function(){console.log("FULL PERSON OBJ:",e.person),e.skillsToRecord.length&&(console.log("NEW SKILLS TO BACK:",e.skillsToRecord),t.post("/skills/addBulk",{user:e.person.user,skills:e.skillsToRecord}).then(function(t){e.allSkills=t.data})),e.person.work=angular.copy(e.person.jobs),t.post("/user/new",e.person).then(function(s){"err"==s.data?bootbox.alert("There was an issue registering! Sorry about that!"):bootbox.alert("Welcome to ActiveRez, "+e.person.first+"!",function(){t.post("/user/login",{user:e.person.user,pwd:e.person.pwd}).then(function(e){e.data&&"no"!=e.data?window.location.href="./":bootbox.alert("You have successfully registered, but there was a login error!",function(){o.go("appSimp.login")})})})})},e.newWork={},e.newEdu={},e.addOthViz=!1,e.addWorkViz=!1,e.addEduViz=!1,e.addTag=function(){return!!e.newSkillTag&&void e.newSkill.tags.push({name:e.newSkillTag,rating:100})},e.newSkNew=!1,e.newJobNew=!1,e.skillsToRecord=[],e.removeTag=function(t){e.newSkill.slice(t,1)},e.addSkill=function(){var t=null;return e.newSkNew?(t=angular.copy(e.newSkill),e.skillsToRecord.push(angular.copy(t))):t=angular.copy(e.pikSkill),!(e.person.skills.indexOf(t.name)>-1)&&(e.pikSkill="",e.newSkill={name:"",tags:[]},t.yrs=0,void e.person.skills.push(t))},e.removeSkill=function(t){e.person.skills.slice(t,1)},e.jobTitles=["Front-end developer","UI/UX Specialist","Tank","Healer","DPS","Back-end developer"]}]),String.prototype.capMe=function(){return this.slice(0,1).toUpperCase()+this.slice(1)},app.controller("main-cont",["$scope","$http","$state","userFact",function(e,t,o,s){e.logout=function(){bootbox.confirm("Are you sure you wish to logout?",function(e){return!e||null==e||void t.get("/user/logout").then(function(e){console.log(e),o.go("appSimp.login")})})},e.hidden={general:!1,personal:!1,account:!1},e.refUsr=function(){s.getUser().then(function(o){t.get("/skills/all").then(function(t){o.user.skills.forEach(function(e){e.id=0;for(var o=0;o<t.data.length;o++)e.name==t.data[o].name&&(e.id=o)}),e.user=o.user,e.skillList=t.data})})},e.refUsr(),e.user=null,e.efl={pwd:"Password",user:"Username",first:"First Name",email:"E-Mail",github:"Github Username",last:"Last Name",city:"City",state:"State",phone:"Phone",summary:"Summary",jobTitle:"Job Title",work:"Work Experience",edu:"Education",exp:"Other Experience",skills:"Skills",cName:"Company Name",sName:"School Name",eName:"Experience Name",position:"Position",other:"Other"},e.moAndYr=function(e){var t=new Date(e);return t.getMonth()+1+"/"+t.getFullYear()},e.removeItem=function(o,s){bootbox.confirm({title:"Remove "+e.efl[o],message:"Are you sure you want to delete this ${$scope.efl[t]}?",callback:function(r){r&&t.post("/user/removeListItem",{user:e.user,cat:o,n:s})}})},e.addCat={work:[{n:"cName",desc:"Company/Organization",t:"reg"},{n:"position",desc:"Position",t:"reg"},{n:"other",desc:"Description",t:"ta"},{n:"start",desc:"Start Date (or best guess)",t:"date"},{n:"current",desc:"Current Company",t:"cb"},{n:"end",desc:"End Date (or best guess)",t:"date"}],edu:[{n:"sName",desc:"Name of School",t:"reg"},{n:"field",desc:"Area of Study",t:"reg"},{n:"other",desc:"Description",t:"ta"},{n:"start",desc:"Start Date (or best guess)",t:"date"},{n:"current",desc:"Currently Attending",t:"cb"},{n:"end",desc:"End Date (or best guess)",t:"date"}],exp:[{n:"eName",desc:"Name of Organization",t:"reg"},{n:"other",desc:"Description",t:"ta"},{n:"start",desc:"Start Date (or best guess)",t:"date"},{n:"current",desc:"Ongoing",t:"cb"},{n:"end",desc:"End Date (or best guess)",t:"date"}]},e.updateSkill=function(o){t.post("/user/editSkill",{user:e.user.user,skill:o}).then(function(t){e.refUsr()})},e.addListItem=function(t){console.log(t);for(var o="Enter information for a new "+e.efl[t].toLowerCase()+". ",s=0;s<e.addCat[t].length;s++)"reg"==e.addCat[t][s].t?o+="<div class='row col-md-offset-1'><div class='input-group col-md-8'><span class='input-group-addon'>"+e.addCat[t][s].desc+"</span><input type='text' class='form-control' id='new-"+e.addCat[t][s].n+"'></div></div><br>":"ta"==e.addCat[t][s].t?o+="<div class='row col-md-offset-1 big-info'><div class='input-group col-md-8'><span class='input-group-addon'>"+e.addCat[t][s].desc+"</span><textarea class='form-control' id='new-"+e.addCat[t][s].n+"'></textarea></div></div><br>":"cb"==e.addCat[t][s].t&&(o+="<div class='row col-md-offset-1'><div class='input-group col-md-8'><span class='input-group-addon'>"+e.addCat[t][s].desc+"</span><input type='checkbox' class='form-control' id='new-"+e.addCat[t][s].n+"'></div></div><br>");bootbox.dialog({title:"Add New "+e.efl[t],message:o})},e.editObj={title:"",items:[]},e.editField=function(o,s){if(console.log("N",o,"P",s),"pwd"==o)bootbox.dialog({title:"Change Password",message:"<div class='row col-md-offset-1'><div class='input-group col-md-8'><span class='input-group-addon'>Old Password</span><input type='password' class='form-control' id='old-pwd'></div></div><br><div class='row col-md-offset-1'><div class='input-group col-md-8'><span class='input-group-addon'>New Password</span><input type='password' class='form-control' id='new-pwd'></div></div><br><div class='row col-md-offset-1'><div class='input-group col-md-8'><span class='input-group-addon'>New Password (again)</span><input type='password' class='form-control' id='pwd-dup'></div></div>",buttons:{confirm:{label:'<i class="fa fa-check"></i> Accept',className:"btn-primary",callback:function(){var o=$("#old-pwd").val(),s=$("#new-pwd").val(),r=$("#pwd-dup").val();return s!=r?(bootbox.alert("Error: Your passwords don't match!"),!1):void t.post("/user/editPwd",{user:e.user.user,"new":s,old:o}).then(function(e){"err"!=e.data?bootbox.alert("Your password was successfully changed!"):bootbox.alert("There was an issue changing your password!")})}},cancel:{label:'<i class="fa fa-times"></i> Cancel',className:"btn-info"}}});else if(s||0===s){var r=e.user[o][s];e.editObj.title=e.efl[o],e.editObj.cat=o,e.editObj.curr=r.current,console.log(r),e.editObj.items=[],e.editObj.n=s,e.addCat[o].forEach(function(t){e.editObj.items.push({sn:t.n,d:t.desc,t:t.t,val:"date"==t.t?new Date(r[t.n]):r[t.n]})})}else bootbox.dialog({title:"Edit "+e.efl[o],message:"Enter a new "+e.efl[o]+":<hr><div class='panel panel-primary panel-body text-center'><em>Current "+e.efl[o]+":</em> "+e.user[o]+"</div><hr><em>New "+e.efl[o]+":</em>&nbsp;<input type='text' id='newVal'>",buttons:{confirm:{label:'<i class="fa fa-check"></i> Accept',className:"btn-primary",callback:function(){var s=$("#newVal").val();t.post("/user/editGeneral",{user:e.user.user,"new":s,field:o}).then(function(t){"err"==t.data?bootbox.alert("There was an error changing your "+e.efl[o]+"!"):e.refUsr()})}},cancel:{label:'<i class="fa fa-times"></i> Cancel',className:"btn-info"}}})},e.newSkill={},e.setupNewSkill=function(){e.newSkill={yrs:0},e.addSkill=!0},e.addTag=function(t){return!!t&&(e.newSkill.tags||(e.newSkill.tags=[]),e.newSkill.tags.push({name:t.name,rating:100}),void console.log(e.newSkill,t))},$,e.removeTag=function(t){console.log("REMOVING",t,"FROM",e.newSkill.tags),e.newSkill.tags.splice(t,1)},e.resetSkill=function(){e.newSkill={yrs:0},e.addSkill=!1},e.toggleNewSk=function(t){e.newSkNew="1"==t},e.newSkNew=!1,e.pikSkill={},e.saveNewSkill=function(){if(e.newSkill.yrs){var o=null;e.newSkNew?(console.log("NEW SK:",e.newSkill),o=angular.copy(e.newSkill),o.user=e.user.user,t.post("/skills/new",o).then(function(t){e.skills=t.data})):(o=angular.copy(e.pikSkill),o.user=e.user.user,o.yrs=e.newSkill.yrs),t.post("/user/addSkill",o).then(function(t){e.addSkill=!1,e.refUsr()})}else bootbox.alert("You can't enter a skill with zero years!")},t.get("/skills/all").then(function(t){e.skills=t.data}),t.get("/tags/all").then(function(t){e.tags=t.data}),e.inclFilt=function(e,t){return function(e){if(!t)return!0;for(var o=0;o<t.length;o++)if(t[o].name&&t[o].name==e.name)return!1;return!0}},e.saveList=function(){t.post("/user/editList",{user:e.user.user,n:e.editObj.n,cat:e.editObj.cat,data:e.editObj.items}).then(function(t){"err"==t.data?bootbox.alert("There was an error saving your data!"):(e.refUsr(),e.editObj={title:"",items:[]})})}}]),app.controller("nav-cont",["$scope","$http",function(e,t){}]),resetApp.controller("reset-contr",["$scope","$http",function(e,t){e.key=window.location.href.slice(window.location.href.lastIndexOf("/")+1),t.get("/user/resetUsr/"+e.key).then(function(t){e.user=t.data}),e.doReset=function(){e.user&&e.pwd&&e.pwdDup&&e.pwdDup==e.pwd&&e.key?t.post("/user/resetPwd",{acct:e.user.name,pwd:e.pwd,key:e.key}).then(function(e){"err"==e.data?bootbox.alert("There was an error resetting your password."):window.location.href="../../login"}):bootbox.alert("Error: Missing data. Make sure you&rsquo;ve reached this page from a password reset link, and that you have entered the same password in both fields!")}}]),app.factory("socketFac",["$rootScope",function(e){var t=io.connect();return{on:function(o,s){t.on(o,function(){var o=arguments;e.$apply(function(){s.apply(t,o)})})},emit:function(o,s,r){t.emit(o,s,function(){var o=arguments;e.$apply(function(){r&&r.apply(t,o)})})}}}]),app.run(["$rootScope","$state","$stateParams","$transitions","$q","userFact",function(e,t,o,s,r,n){s.onBefore({to:"app.**"},function(e){var o=r.defer();console.log("TRANS",e);var s=e.injector().get("userFact");return s.getUser().then(function(e){console.log(e.result),e.result?o.resolve(!0):o.resolve(t.target("appSimp.login",void 0,{location:!0}))}),o.promise})}]),app.factory("userFact",["$http",function(e){return{makeGroup:function(){},getDefaultLoc:function(){return e.get("//freegeoip.net/json/").then(function(e){return e.data})},getUser:function(){return e.get("/user/chkLog").then(function(e){return console.log("getUser in fac says:",e),e.data})}}}]);