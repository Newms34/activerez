"use strict";var socket=io(),app=angular.module("ribbon-app",["ui.router","ngAnimate","ui.bootstrap","ngSanitize","chart.js"]),resetApp=angular.module("reset-app",[]);Array.prototype.findUser=function(e){for(var o=0;o<this.length;o++)if(this[o].user==e)return o;return-1},app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,o,t){t.html5Mode(!0),o.otherwise("/404"),e.state("app",{"abstract":!0,templateUrl:"layouts/full.html"}).state("app.dash",{url:"/",templateUrl:"components/dash.html"}).state("app.find",{url:"/find",templateUrl:"components/find.html"}).state("app.help",{url:"/help",templateUrl:"components/help/help.html"}).state("appSimp",{"abstract":!0,templateUrl:"components/layout/simp.html"}).state("appSimp.login",{url:"/login",templateUrl:"components/login.html"}).state("appSimp.register",{url:"/register",templateUrl:"components/register.html"}).state("appSimp.notfound",{url:"/404",templateUrl:"components/alt/404.html"}).state("appSimp.err",{url:"/500",templateUrl:"components/alt/500.html"})}]),app.factory("socketFac",["$rootScope",function(e){var o=io.connect();return{on:function(t,r){o.on(t,function(){var t=arguments;e.$apply(function(){r.apply(o,t)})})},emit:function(t,r,s){o.emit(t,r,function(){var t=arguments;e.$apply(function(){s&&s.apply(o,t)})})}}}]),app.run(["$rootScope","$state","$stateParams","$transitions","$q","userFact",function(e,o,t,r,s,n){r.onBefore({to:"app.**"},function(e){var t=s.defer();console.log("TRANS",e);var r=e.injector().get("userFact");return r.getUser().then(function(e){console.log(e.result),e.result?t.resolve(!0):t.resolve(o.target("appSimp.login",void 0,{location:!0}))}),t.promise})}]),app.factory("userFact",["$http",function(e){return{makeGroup:function(){},getDefaultLoc:function(){return e.get("//freegeoip.net/json/").then(function(e){return e.data})},getUser:function(){return e.get("/user/chkLog").then(function(e){return console.log("getUser in fac says:",e),e.data})}}}]),app.controller("chat-cont",["$scope","userFact","$http","$state","$sce",function(e,o,t,r,s){e.user=null,o.getUser().then(function(o){e.user=o.user,e.getUsrGroups()}),e.hideMe=function(){angular.element("#full-win").scope().showChat=!1,e.$digest()},e.chatGrps=[{title:"Error",groupId:"abc123",description:"This group should not show up!"}],e.prevMsgs=[],e.messages={},e.getUsrGroups=function(){t.post("/group/allByUsr",{user:e.user.name}).then(function(o){e.chatGrps=[],e.messages={},console.log("GROUPS:",o);var t=[];o.data instanceof Array&&(o.data.forEach(function(o){console.log("reinserting messages for group",o),o.recentTime=0,e.messages[o.groupId]=[{name:"Server",msg:'<span class="text-muted"><b>Server:</b> Welcome to '+o.title+" chat! Type <i>/wiki &lt;term&gt;</i> to search Wikipedia or <i>/google &lt;term&gt;</i> to search Google. Your moderator is "+o.creator+"</span>",grp:o.groupId,read:!0}],o.messages.forEach(function(t){var r={msg:t.msg,name:t.user,id:o.groupId};e.parseMsg(r,!0)}),e.chatGrps.push(o),console.log("GROUPS NOW",e.chatGrps),t.push(o.groupId)}),e.switchChat(e.chatGrps[0].groupId),socket.emit("joinRooms",{rooms:t,user:e.user.name}),$("#msg-inp").focus())})},socket.on("refreshGrps",function(){e.getUsrGroups()}),e.send=function(){t.post("/group/msg",{id:e.currId,msg:e.msgTxt,user:e.user.name}).then(function(o){return"err"==o.data?void bootbox.alert("There's been some sort of error with the chat system! Sorry!"):(e.prevMsgs.push(e.msgTxt),e.prevMsgs.length>20&&e.prevMsgs.shift(),e.msgTxt="",e.currCycMsg=e.prevMsgs.length,$("#msg-inp").focus(),e.user.lastRead=(new Date).getTime(),void t.post("/group/setLastRead",{user:e.user.name,id:e.currId}))})},e.switchChat=function(o){$(".chat-main").fadeOut(200,function(){e.currId=o,e.messages[o].forEach(function(e){e.read=!0}),e.$digest(),$(".chat-main").fadeIn()})},e.getNumUnread=function(o){var t=0;return e.messages[o].forEach(function(e){t+=e.read?0:1}),"+"+t},e.parseMsg=function(o,t){return o.grp=o.grp||o.id,!!o.msg&&(console.log("attempting to parse message",o),0==o.msg.indexOf("/wiki ")?o.msg='<a target="_blank" href="https://en.wikipedia.org/wiki/'+o.msg.slice(6).replace(/\s/,"_")+'">'+o.msg.slice(6)+"</a>":0==o.msg.indexOf("/google ")&&(o.msg='<a target="_blank" href="https://www.google.com/search?q='+o.msg.slice(8).replace(/\s/,"+")+'">'+o.msg.slice(8)+"</a>"),o.msg="<b>"+o.name+"</b>:"+o.msg,e.currId==o.grp||t?o.read=!0:o.read=!1,void e.messages[o.grp].push(o))},socket.on("chatOut",function(o){e.parseMsg(o),e.$digest()}),document.querySelector("#msg-inp").addEventListener("keydown",function(o){38==o.which&&e.currCycMsg>0?(e.currCycMsg--,e.msgTxt=e.prevMsgs[e.currCycMsg]):40==o.which&&e.currCycMsg<e.prevMsgs.length?(e.currCycMsg++,e.currCycMsg<e.prevMsgs.length-1?e.msgTxt=e.prevMsgs[e.currCycMsg]:e.msgTxt=""):27==o.which&&(e.msgTxt=""),e.$digest()})}]),app.controller("find-ctrl",["$scope","userFact","$http",function(e,o,t){e.srchMode=0,e.topics=[{name:"Name",icon:"user",desc:"Find a user by name"},{name:"Skill",icon:"cogs",desc:"Find a user by one of their skills"},{name:"Tag",icon:"tag",desc:"Find a user by one of the tags on their skills"}],e.t=null,e.users=[],e.searchTimer=function(){e.t&&clearTimeout(e.t),e.t=setTimeout(function(){0===e.srchMode?t.get("/user/allUsrs").then(function(o){e.users=o.data.filter(function(o){return o.first.toLowerCase().indexOf(e.searchParam.toLowerCase())>-1||o.last.toLowerCase().indexOf(e.searchParam.toLowerCase())>-1})}):1===e.srchMode?t.get("/user/bySkill/"+e.searchParam).then(function(o){e.users=o}):t.get("/user/byTag/"+e.searchParam).then(function(o){e.users=o})},500)}}]),app.controller("log-cont",["$scope","$http","$state","$q","userFact",function(e,o,t,r,s){e.person={jobs:[],edu:[],oth:[],skills:[]},e.allSkills=[],e.tags=[],e.newSkill={name:"",tags:[]},e.pushNewItem=function(o){if("Work"==o)e.person.jobs.push(angular.copy(e.newWork)),e.newWork={};else{var t=o.toLowerCase();console.log("pushing into",e.person[t]),e.person[t].push(angular.copy(e["new"+o])),e["new"+o]={},console.log("result",e.person[t])}e["add"+o+"Viz"]=!1},e.pickTitle=function(){e.newJobNew?e.person.jobTitle=e.jobNew:e.person.jobTitle=e.jobOld,e.titlePicked=!0},o.get("/skills/all").then(function(o){e.allSkills=o.data}),o.get("/tags/all").then(function(o){e.tags=o.data}),e.goReg=function(){t.go("appSimp.register")},e.goLog=function(){t.go("appSimp.login")},e.forgot=function(){return e.user?void o.post("/user/forgot",{user:e.user}).then(function(e){console.log("forgot route response",e),bootbox.alert("Check your email! If your username is registered, you should recieve an email from us with a password reset link.")}):void bootbox.alert("To recieve a password reset email, please enter your username!")},e.signin=function(){return e.user&&e.pwd?void o.post("/user/login",{user:e.user,pwd:e.pwd}).then(function(o){o.data&&"no"!=o.data?window.location.href="./":bootbox.alert("Invalid username or password!",function(){e.pwd="",e.user="",e.$digest()})}):(bootbox.alert("Please enter your username and password."),!1)},e.titlePicked=!1,e.nameDup=!1,e.nt=null,e.nameTimer=function(){e.nt&&clearTimeout(e.nt),e.nt=setTimeout(function(){e.checkName()},500)},e.checkName=function(){o.get("/user/nameOkay/"+e.user).then(function(o){console.log(o.data),e.nameDup="okay"!=o.data})},e.explTxts=["Basic information for your account. You know, the usual stuff, like login info.","General information. Who/where are you.","Give potential employers a summary of who you are. Write brief summary of yourself, and pick a job title.","What positions have you had in the past?","Where did you learn your stuff? Tell us here!","Not all great experience comes from a 9-to-5. Got some great extra-curricular experience? Let us know here!","The fun part! Tell us all the cool things you can do! Either pick a skill from the list, or add your own."],e.expl=function(o){bootbox.alert(e.explTxts[o])},s.getDefaultLoc().then(function(o){e.city=o.city,e.state=o.region_name}),e.reg=function(){for(var o=[],t=0;t<e.person.skills.length;t++)e.person.skills[t].yrs||o.push(e.person.skills[t].name);return e.regForm.$valid?void(e.person.pwd!=e.pwdDup?bootbox.alert("Your passwords don&rsquo;t match!"):e.nameDup?bootbox.alert("Someone&rsquo;s already using this username. Please pick another one!"):o.length?bootbox.confirm({message:"The following skills have their Years of Experience set to zero!<br/><ul><li>"+o.join("</li><li>")+"</li></ul><br/>We'd recommend either increasing the years of experience to at least 0.5 (half a year), or removing the skill. Are you sure you want to continue?",callback:function(o){o&&e.doReg()}}):e.doReg()):(bootbox.alert("One or more of your fields is missing. Please double-check your information!"),!1)},e.doReg=function(){console.log("FULL PERSON OBJ:",e.person),e.skillsToRecord.length&&(console.log("NEW SKILLS TO BACK:",e.skillsToRecord),o.post("/skills/addBulk",{user:e.person.user,skills:e.skillsToRecord}).then(function(o){e.allSkills=o.data})),o.post("/user/new",e.person).then(function(r){"err"==r.data?bootbox.alert("There was an issue registering! Sorry about that!"):bootbox.alert("Welcome to ActiveRez, "+e.person.first+"!",function(){o.post("/user/login",{user:e.person.user,pwd:e.person.pwd}).then(function(e){e.data&&"no"!=e.data?window.location.href="./":bootbox.alert("You have successfully registered, but there was a login error!",function(){t.go("appSimp.login")})})})})},e.newWork={},e.newEdu={},e.addOthViz=!1,e.addWorkViz=!1,e.addEduViz=!1,e.addTag=function(){return!!e.newSkillTag&&void e.newSkill.tags.push({name:e.newSkillTag,rating:100})},e.newSkNew=!1,e.newJobNew=!1,e.skillsToRecord=[],e.removeTag=function(o){e.newSkill.slice(o,1)},e.addSkill=function(){var o=null;return e.newSkNew?(o=angular.copy(e.newSkill),e.skillsToRecord.push(angular.copy(o))):o=angular.copy(e.pikSkill),!(e.person.skills.indexOf(o.name)>-1)&&(e.pikSkill="",e.newSkill={name:"",tags:[]},o.yrs=0,void e.person.skills.push(o))},e.removeSkill=function(o){e.person.skills.slice(o,1)},e.jobTitles=["Front-end developer","UI/UX Specialist","Tank","Healer","DPS","Back-end developer"]}]),String.prototype.capMe=function(){return this.slice(0,1).toUpperCase()+this.slice(1)},app.controller("main-cont",["$scope","$http","$state","userFact",function(e,o,t,r){e.logout=function(){bootbox.confirm("Are you sure you wish to logout?",function(e){return!e||null==e||void o.get("/user/logout").then(function(e){console.log(e),t.go("appSimp.login")})})},e.hidden={general:!1,personal:!1,account:!1},e.refUsr=function(){r.getUser().then(function(t){o.get("/skills/all").then(function(o){t.user.skills.forEach(function(e){e.id=0;for(var t=0;t<o.data.length;t++)e.name==o.data[t].name&&(e.id=t)}),e.user=t.user,e.skillList=o.data})})},e.refUsr(),e.user=null}]),app.controller("nav-cont",["$scope","$http",function(e,o){}]),resetApp.controller("reset-contr",["$scope","$http",function(e,o){e.key=window.location.href.slice(window.location.href.lastIndexOf("/")+1),o.get("/user/resetUsr/"+e.key).then(function(o){e.user=o.data}),e.doReset=function(){e.user&&e.pwd&&e.pwdDup&&e.pwdDup==e.pwd&&e.key?o.post("/user/resetPwd",{acct:e.user.name,pwd:e.pwd,key:e.key}).then(function(e){"err"==e.data?bootbox.alert("There was an error resetting your password."):window.location.href="../../login"}):bootbox.alert("Error: Missing data. Make sure you&rsquo;ve reached this page from a password reset link, and that you have entered the same password in both fields!")}}]);